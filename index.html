<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>â€œè™šæ‹Ÿäº§å“ç²‰çº¢ç¨â€è°ƒæŸ¥æ•°æ®çœ‹æ¿</title>
  <!-- å¼•å…¥ ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background-color: #f4f7f6;
      margin: 0;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #333;
      margin: 0;
      font-size: 28px;
    }

    .header p {
      color: #666;
      margin-top: 10px;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      /* ä¸¤åˆ—å¸ƒå±€ */
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .chart-box {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      height: 400px;
      /* å›ºå®šé«˜åº¦ */
    }

    h2 {
      font-size: 18px;
      color: #333;
      border-left: 4px solid #5470c6;
      padding-left: 10px;
      margin-top: 0;
      margin-bottom: 20px;
    }

    /* AI Section Styles */
    .ai-section {
      grid-column: 1 / -1;
      /* è·¨è¶Šä¸¤åˆ— */
      background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
      border-radius: 12px;
      padding: 30px;
      margin-top: 20px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .ai-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .ai-header h2 {
      margin: 0;
      border: none;
      font-size: 22px;
      background: linear-gradient(90deg, #5470c6, #91cc75);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .ai-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .ai-btn {
      background-color: #5470c6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .ai-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(84, 112, 198, 0.3);
    }

    .ai-btn.secondary {
      background-color: #91cc75;
    }

    .ai-btn.secondary:hover {
      box-shadow: 0 4px 8px rgba(145, 204, 117, 0.3);
    }

    .ai-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .ai-output {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #eee;
      min-height: 100px;
      white-space: pre-wrap;
      line-height: 1.6;
      color: #444;
      font-size: 15px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, .3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* æ‰‹æœºç«¯é€‚é…ï¼šå˜ä¸ºå•åˆ— */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>â€œè™šæ‹Ÿäº§å“ç²‰çº¢ç¨â€è°ƒæŸ¥æ ¸å¿ƒæ•°æ®çœ‹æ¿</h1>
    <p>æ­£å¤§æ¯å‚èµ›å›¢é˜Ÿæ•°æ®åˆ†æç»„ | æ ·æœ¬é‡ï¼š101ä»½</p>
  </div>

  <div class="container">
    <!-- å›¾è¡¨1 -->
    <div class="chart-box">
      <h2>1. è™šæ‹Ÿç²‰çº¢ç¨â€œé‡ç¾åŒºâ€ (æåŠé¢‘æ¬¡)</h2>
      <div id="chart1" style="width: 100%; height: 340px;"></div>
    </div>

    <!-- å›¾è¡¨2 -->
    <div class="chart-box">
      <h2>2. æ¶ˆè´¹è€…å½’å› åˆ†æ (ä¸ºä»€ä¹ˆä¼šæœ‰ï¼Ÿ)</h2>
      <div id="chart2" style="width: 100%; height: 340px;"></div>
    </div>

    <!-- å›¾è¡¨3 -->
    <div class="chart-box">
      <h2>3. é­é‡ç²‰çº¢ç¨åçš„è¡Œä¸ºåé¦ˆ</h2>
      <div id="chart3" style="width: 100%; height: 340px;"></div>
    </div>

    <!-- å›¾è¡¨4 -->
    <div class="chart-box">
      <h2>4. ä¸åŒæ€§åˆ«çš„åº”å¯¹ç­–ç•¥å·®å¼‚</h2>
      <div id="chart4" style="width: 100%; height: 340px;"></div>
    </div>

    <!-- AI åˆ†æåŒºåŸŸ -->
    <div class="ai-section">
      <div class="ai-header">
        <h2>âœ¨ AI æ™ºèƒ½åˆ†æå®éªŒå®¤</h2>
      </div>
      <p style="color: #666; margin-bottom: 20px;">åŸºäº Gemini å¤§æ¨¡å‹ï¼Œå®æ—¶è§£è¯»ä¸Šæ–¹å›¾è¡¨æ•°æ®ã€‚</p>
      <div class="ai-controls">
        <button class="ai-btn" onclick="generateAnalysis()">
          <span>âœ¨ ç”Ÿæˆæ·±åº¦æ´å¯ŸæŠ¥å‘Š</span>
        </button>
        <button class="ai-btn secondary" onclick="generateRecommendations()">
          <span>ğŸ›¡ï¸ è·å–é¿å‘ä¸ç»´æƒæŒ‡å—</span>
        </button>
      </div>
      <div id="aiOutput" class="ai-output">è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼ŒAI å°†ä¸ºæ‚¨åˆ†ææ•°æ®...</div>
    </div>
  </div>

  <script>
    // --- å‡†å¤‡æ•°æ® (åŸºäºä¹‹å‰çš„ Python åˆ†æç»“æœ) ---
    // 1. é‡ç¾åŒºæ•°æ®
    const productData = [
      { value: 53, name: 'æ¸¸æˆçš®è‚¤/ç¤¼åŒ…' },
      { value: 49, name: 'è™šæ‹Ÿå½¢è±¡/è£…æ‰®' },
      { value: 45, name: 'å¥³æ€§å‘å†…å®¹(å°è¯´/è¯¾)' },
      { value: 38, name: 'éŸ³è§†é¢‘ä¼šå‘˜' },
      { value: 35, name: 'å·¥å…·è½¯ä»¶' }
    ];

    // 2. å½’å› æ•°æ®
    const reasonData = [
      { value: 64, name: 'åˆ©ç”¨é¢œå€¼/æƒ…æ„Ÿè¥é”€' },
      { value: 59, name: 'å¥³æ€§ä»˜è´¹æ„æ„¿å¼º' },
      { value: 47, name: 'éšæ€§æ­§è§†/å‰²éŸ­èœ' },
      { value: 34, name: 'è®¾è®¡å®šåˆ¶æˆæœ¬é«˜' }
    ];

    // 3. è¡Œä¸ºåé¦ˆæ•°æ®
    const reactionData = [
      { value: 28, name: 'å¯»æ‰¾å¹³æ›¿' },
      { value: 25, name: 'è§†ä»·æ ¼å·®è€Œå®š' },
      { value: 19, name: 'æ— å¥ˆå¦¥å/åˆšéœ€' },
      { value: 17, name: 'è´­ä¹°æ™®é€šç‰ˆ' },
      { value: 12, name: 'ç›´æ¥æŠµåˆ¶' }
    ];

    // 4. æ€§åˆ«å·®å¼‚æ•°æ® (è¿‘ä¼¼æ¯”ä¾‹)
    const genderData = {
      categories: ['å¯»æ‰¾å¹³æ›¿', 'è´­ä¹°æ™®é€šç‰ˆ', 'æ— å¥ˆå¦¥å', 'è§†æƒ…å†µè€Œå®š', 'ç›´æ¥æŠµåˆ¶'],
      female: [29, 13, 19, 25, 14], // å¥³æ€§æ•°æ®
      male: [25, 25, 19, 25, 6]   // ç”·æ€§æ•°æ®
    };

    // --- åˆå§‹åŒ–å›¾è¡¨ ---

    // Chart 1: æ¡å½¢å›¾ (é‡ç¾åŒº)
    const chart1 = echarts.init(document.getElementById('chart1'));
    chart1.setOption({
      tooltip: { trigger: 'axis' },
      grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
      xAxis: { type: 'value' },
      yAxis: { type: 'category', data: productData.map(item => item.name).reverse() },
      series: [{
        name: 'æåŠæ¬¡æ•°',
        type: 'bar',
        data: productData.map(item => item.value).reverse(),
        itemStyle: { color: '#5470c6' },
        label: { show: true, position: 'right' }
      }]
    });

    // Chart 2: æ¡å½¢å›¾ (å½’å› )
    const chart2 = echarts.init(document.getElementById('chart2'));
    chart2.setOption({
      tooltip: { trigger: 'axis' },
      grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
      xAxis: { type: 'value' },
      yAxis: { type: 'category', data: reasonData.map(item => item.name).reverse() },
      series: [{
        name: 'æåŠæ¬¡æ•°',
        type: 'bar',
        data: reasonData.map(item => item.value).reverse(),
        itemStyle: { color: '#91cc75' },
        label: { show: true, position: 'right' }
      }]
    });

    // Chart 3: ç¯å½¢å›¾ (è¡Œä¸º)
    const chart3 = echarts.init(document.getElementById('chart3'));
    chart3.setOption({
      tooltip: { trigger: 'item' },
      legend: { orient: 'vertical', left: 'left', top: 'center' },
      series: [{
        name: 'åº”å¯¹è¡Œä¸º',
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['60%', '50%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 5,
          borderColor: '#fff',
          borderWidth: 2
        },
        label: { show: false },
        emphasis: {
          label: { show: true, fontSize: 16, fontWeight: 'bold' }
        },
        data: reactionData
      }]
    });

    // Chart 4: åˆ†ç»„æŸ±çŠ¶å›¾ (æ€§åˆ«å·®å¼‚)
    const chart4 = echarts.init(document.getElementById('chart4'));
    chart4.setOption({
      tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
      legend: { data: ['å¥³æ€§', 'ç”·æ€§'] },
      grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
      xAxis: { type: 'category', data: genderData.categories },
      yAxis: { type: 'value', name: 'å æ¯”(%)' },
      series: [
        {
          name: 'å¥³æ€§',
          type: 'bar',
          data: genderData.female,
          itemStyle: { color: '#ee6666' }
        },
        {
          name: 'ç”·æ€§',
          type: 'bar',
          data: genderData.male,
          itemStyle: { color: '#73c0de' }
        }
      ]
    });

    // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜
    window.addEventListener('resize', function () {
      chart1.resize();
      chart2.resize();
      chart3.resize();
      chart4.resize();
    });

    // --- Gemini AI é›†æˆ ---
    const apiKey = ""; // è¿è¡Œæ—¶è‡ªåŠ¨æ³¨å…¥

    async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (response.ok) return response;
          if (response.status !== 429 && response.status < 500) {
            return response;
          }
        } catch (err) {
          console.warn(`Attempt ${i + 1} failed. Retrying...`);
        }
        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
      }
      throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥ã€‚');
    }

    async function callGemini(userPrompt, systemRole) {
      const outputDiv = document.getElementById('aiOutput');
      const btns = document.querySelectorAll('.ai-btn');

      // UI Loading State
      btns.forEach(b => b.disabled = true);
      outputDiv.innerHTML = '<div style="display:flex; align-items:center; gap:10px;"><span class="loading"></span> æ­£åœ¨åˆ†æ 101 ä»½æ ·æœ¬æ•°æ®ï¼Œè¯·ç¨å€™...</div>';

      const contextData = `
            å½“å‰é—®å·è°ƒæŸ¥æ•°æ®å¦‚ä¸‹ï¼š
            1. [ç²‰çº¢ç¨é«˜å‘åŒº]ï¼š${JSON.stringify(productData)}ã€‚
            2. [å½’å› åˆ†æ]ï¼š${JSON.stringify(reasonData)}ã€‚
            3. [è¡Œä¸ºåé¦ˆ]ï¼š${JSON.stringify(reactionData)}ã€‚
            4. [æ€§åˆ«å·®å¼‚]ï¼š${JSON.stringify(genderData)}ã€‚
            `;

      const fullPrompt = `èƒŒæ™¯æ•°æ®ï¼š${contextData}\n\nä»»åŠ¡æŒ‡ä»¤ï¼š${userPrompt}`;

      try {
        const response = await fetchWithRetry(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: fullPrompt }] }],
              systemInstruction: { parts: [{ text: systemRole }] }
            })
          }
        );

        if (!response.ok) throw new Error('API Error');

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "æœªèƒ½ç”Ÿæˆå†…å®¹ï¼Œè¯·é‡è¯•ã€‚";

        // Simple formatting
        outputDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

      } catch (error) {
        outputDiv.innerHTML = `<span style="color:red;">åˆ†æå¤±è´¥ï¼šè¯·ç¨åå†è¯•ã€‚(${error.message})</span>`;
      } finally {
        btns.forEach(b => b.disabled = false);
      }
    }

    function generateAnalysis() {
      const prompt = "è¯·ä½œä¸ºä¸€åç¤¾ä¼šå­¦æ•°æ®åˆ†æå¸ˆï¼Œå¯¹ä¸Šè¿°æ•°æ®è¿›è¡Œæ·±åº¦è§£è¯»ã€‚é‡ç‚¹åˆ†æï¼š1. è™šæ‹Ÿäº§å“ä¸­ç²‰çº¢ç¨çš„éšè”½æ€§ï¼›2. æ¶ˆè´¹è€…å¯¹â€˜é¢œå€¼ä»˜è´¹â€™çš„çŸ›ç›¾å¿ƒç†ï¼›3. æ€§åˆ«å·®å¼‚åæ˜ å‡ºçš„ç»´æƒæ„è¯†è§‰é†’ã€‚è¯·è¾“å‡ºä¸€æ®µé€‚åˆæ”¾å…¥â€˜æ­£å¤§æ¯â€™è°ƒç ”æŠ¥å‘Šâ€˜æ•°æ®åˆ†æâ€™ç« èŠ‚çš„ä¸“ä¸šæ–‡å­—ï¼Œå­—æ•°300å­—å·¦å³ã€‚";
      const role = "ä½ æ˜¯ä¸€åä¸ºâ€˜æ­£å¤§æ¯â€™å¸‚åœºè°ƒç ”å¤§èµ›æœåŠ¡çš„ä¸“ä¸šæ•°æ®åˆ†æå¸ˆï¼Œè¯­è¨€é£æ ¼å­¦æœ¯ã€ä¸¥è°¨ä¸”å…·æœ‰æ´å¯ŸåŠ›ã€‚";
      callGemini(prompt, role);
    }

    function generateRecommendations() {
      const prompt = "åŸºäºæ•°æ®ï¼ˆç‰¹åˆ«æ˜¯æ¶ˆè´¹è€…åé¦ˆå’Œå½’å› ï¼‰ï¼Œè¯·æå‡º3æ¡é’ˆå¯¹æ¶ˆè´¹è€…çš„å…·ä½“é¿å‘å»ºè®®ï¼Œä»¥åŠ3æ¡é’ˆå¯¹å¸‚åœºç›‘ç®¡éƒ¨é—¨çš„æ”¿ç­–å»ºè®®ã€‚å»ºè®®è¦å…·ä½“ã€å¯è¡Œã€‚";
      const role = "ä½ æ˜¯ä¸€åç»´æŠ¤æ¶ˆè´¹è€…æƒç›Šçš„æ”¿ç­–é¡¾é—®ï¼Œæ“…é•¿æå‡ºå»ºè®¾æ€§çš„è§£å†³æ–¹æ¡ˆã€‚";
      callGemini(prompt, role);
    }
  </script>
</body>

</html>